name: Cleanup Untagged AWS Resources

on:
  workflow_dispatch:
    inputs:
      execute_cleanup:
        description: 'Execute actual cleanup (vs dry-run)'
        required: false
        default: 'false'
        type: boolean
      force_cleanup:
        description: 'Skip confirmation prompts (DANGEROUS - use with caution)'
        required: false
        default: 'false'
        type: boolean
      verbose_mode:
        description: 'Enable verbose output'
        required: false
        default: 'false'
        type: boolean

env:
  AWS_REGION: us-east-1
  TF_VERSION: '1.5.0'

permissions:
  contents: read

jobs:
  cleanup:
    name: Cleanup Untagged Resources
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install jq for JSON processing
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Display cleanup configuration
        run: |
          echo "========================================="
          echo "ðŸ”§ CLEANUP CONFIGURATION"
          echo "========================================="
          echo "Region: ${{ env.AWS_REGION }}"
          echo "Execute Mode: ${{ github.event.inputs.execute_cleanup == 'true' && 'ENABLED' || 'DISABLED (dry-run)' }}"
          echo "Force Mode: ${{ github.event.inputs.force_cleanup == 'true' && 'ENABLED (dangerous)' || 'DISABLED (safe)' }}"
          echo "Verbose Mode: ${{ github.event.inputs.verbose_mode == 'true' && 'ENABLED' || 'DISABLED' }}"
          echo "Target: Resources with Project=NT114_DevSecOps OR Environment=dev OR Terraform tags"
          echo "========================================="

      - name: Cleanup Resources WITHOUT Project Tag
        run: |
          chmod +x scripts/cleanup-aws-resources.sh

          # Build command arguments
          ARGS=""
          if [ "${{ github.event.inputs.execute_cleanup }}" = "true" ]; then
            ARGS="$ARGS --execute"
          fi
          if [ "${{ github.event.inputs.force_cleanup }}" = "true" ]; then
            ARGS="$ARGS --force"
          fi
          if [ "${{ github.event.inputs.verbose_mode }}" = "true" ]; then
            ARGS="$ARGS --verbose"
          fi

          echo "ðŸš€ Running: scripts/cleanup-aws-resources.sh $ARGS"
          scripts/cleanup-aws-resources.sh $ARGS

      - name: Cleanup Summary
        run: |
          echo "### ðŸ—‘ï¸ Cleanup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Filter:** Resources with Project=NT114_DevSecOps OR Environment=dev OR Terraform tags" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ github.event.inputs.execute_cleanup == 'true' && 'EXECUTE' || 'DRY-RUN' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Safety Measures Applied:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Resource whitelisting (default/critical infrastructure)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Age-based filtering (protects resources < 24h old)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Interactive confirmations ${{ github.event.inputs.force_cleanup == 'true' && '(disabled)' || '(enabled)' }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dry-run mode ${{ github.event.inputs.execute_cleanup == 'true' && '(disabled)' || '(enabled)' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resources Checked:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” EKS Clusters & Node Groups" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Load Balancers (ALB & Classic)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” EC2 Instances" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Auto Scaling Groups" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” VPCs and Networking" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” IAM Roles" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” EBS Volumes" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” ECR Repositories" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” CloudWatch Logs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.execute_cleanup }}" = "true" ]; then
            echo "âš ï¸ **WARNING:** Actual resource deletion was performed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **SAFE:** Dry-run mode only - no resources were deleted" >> $GITHUB_STEP_SUMMARY
          fi
