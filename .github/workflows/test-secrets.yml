name: Test Secrets Configuration

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        type: choice
        options:
          - terraform_plan
          - migration_dry_run
          - full_validation
        default: 'full_validation'

jobs:
  test-terraform-secrets:
    runs-on: ubuntu-latest
    if: inputs.test_type == 'terraform_plan' || inputs.test_type == 'full_validation'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.9.0'
          terraform_wrapper: false

      - name: Test Bastion Public Key Variable
        run: |
          cd terraform/environments/dev

          # Test if TF_VAR_bastion_public_key is accessible
          if [[ -n "${{ secrets.BASTION_PUBLIC_KEY }}" ]]; then
            echo "✅ BASTION_PUBLIC_KEY secret accessible"

            # Export and test variable
            export TF_VAR_bastion_public_key="${{ secrets.BASTION_PUBLIC_KEY }}"

            # Run terraform validate
            terraform init -backend=false
            if terraform validate; then
              echo "✅ Terraform validation passed with bastion_public_key"
            else
              echo "❌ Terraform validation failed"
              exit 1
            fi

            # Run terraform plan (dry run)
            if terraform plan -out=test.tfplan; then
              echo "✅ Terraform plan succeeded"
              rm test.tfplan
            else
              echo "❌ Terraform plan failed"
              exit 1
            fi
          else
            echo "❌ BASTION_PUBLIC_KEY secret not accessible"
            exit 1
          fi

  test-migration-secrets:
    runs-on: ubuntu-latest
    if: inputs.test_type == 'migration_dry_run' || inputs.test_type == 'full_validation'

    steps:
      - name: Test Migration Secrets
        run: |
          echo "Testing database migration secrets..."

          # Test SSH private key format
          if [[ -n "${{ secrets.BASTION_SSH_PRIVATE_KEY }}" ]]; then
            echo "✅ BASTION_SSH_PRIVATE_KEY secret accessible"

            # Write key to temporary file and test format
            echo "${{ secrets.BASTION_SSH_PRIVATE_KEY }}" > test_key.pem

            if ssh-keygen -l -f test_key.pem > /dev/null 2>&1; then
              echo "✅ Private key format valid"
            else
              echo "❌ Invalid private key format"
              rm test_key.pem
              exit 1
            fi

            rm test_key.pem
          else
            echo "❌ BASTION_SSH_PRIVATE_KEY secret not accessible"
            exit 1
          fi

          echo "✅ Migration secrets validation complete"