name: Emergency AWS Resource Cleanup

on:
  repository_dispatch:
    types: [emergency_cleanup]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to clean'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'
      force_cleanup:
        description: 'Force cleanup of ALL AWS resources (dangerous)'
        required: false
        type: boolean
        default: false

env:
  AWS_REGION: us-east-1
  TF_VERSION: '1.9.0'

permissions:
  contents: write
  issues: write
  actions: write

jobs:
  emergency-cleanup:
    name: Emergency Cleanup
    runs-on: ubuntu-latest
    if: github.event_name == 'repository_dispatch' || github.event.inputs.force_cleanup == 'true'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Initialize Terraform
        run: |
          cd terraform/environments/${{ github.event.client_payload.environment || inputs.environment || 'dev' }}
          terraform init -input=false

      - name: Force Destroy All Terraform Resources
        run: |
          echo "ðŸš¨ EMERGENCY CLEANUP TRIGGERED ðŸš¨"
          echo "Environment: ${{ github.event.client_payload.environment || inputs.environment || 'dev' }}"
          echo "Run ID: ${{ github.event.client_payload.run_id || 'manual' }}"
          echo "Failed Job: ${{ github.event.client_payload.failed_job || 'manual' }}"

          cd terraform/environments/${{ github.event.client_payload.environment || inputs.environment || 'dev' }}

          # Attempt graceful destroy first
          echo "Attempting graceful Terraform destroy..."
          timeout 300 terraform destroy -auto-approve -refresh=false || echo "Graceful destroy failed or timed out"

          # Force destroy if graceful fails
          echo "Attempting force destroy..."
          timeout 300 terraform destroy -auto-approve -refresh=false -lock-timeout=600s || echo "Force destroy also failed"

          echo "âœ… Terraform cleanup completed"

      - name: Run Comprehensive AWS Cleanup Script
        run: |
          echo "ðŸ”¥ Running comprehensive AWS resource cleanup..."

          # Make the cleanup script executable
          chmod +x scripts/cleanup-aws-resources.sh

          # Run comprehensive cleanup
          cd terraform/environments/${{ github.event.client_payload.environment || inputs.environment || 'dev' }}

          ../../../../scripts/cleanup-aws-resources.sh || echo "Cleanup script completed with warnings"

      - name: Final Verification Cleanup
        run: |
          echo "ðŸ§¹ Running final verification cleanup..."

          # Clean up any orphaned resources
          cd terraform/environments/${{ github.event.client_payload.environment || inputs.environment || 'dev' }}

          # Remove any remaining Terraform state
          rm -rf .terraform/
          rm -f *.tfstate*
          rm -f tfplan

          echo "âœ… Emergency cleanup completed successfully"

      - name: Create Cleanup Report
        run: |
          echo "ðŸ“‹ Generating cleanup report..."

          cat << 'EOF' > cleanup-report-${{ github.run_id }}.md
          # Emergency Cleanup Report

          **Timestamp:** $(date)
          **Environment:** ${{ github.event.client_payload.environment || inputs.environment || 'dev' }}
          **Triggered by:** ${{ github.event.client_payload.run_id || 'manual' }}
          **Failed Job:** ${{ github.event.client_payload.failed_job || 'manual' }}

          ## Actions Performed
          1. âœ… Terraform graceful destroy attempt
          2. âœ… Terraform force destroy attempt
          3. âœ… Comprehensive AWS resource cleanup script
          4. âœ… Final verification cleanup
          5. âœ… Terraform state files removal

          ## Status
          **Cleanup Status:** COMPLETED
          **Repository Status:** Ready for new deployment attempt

          ---
          *This report was automatically generated by the Emergency Cleanup workflow*
          EOF

          echo "Cleanup report generated: cleanup-report-${{ github.run_id }}.md"

      - name: Upload Cleanup Report
        uses: actions/upload-artifact@v4
        with:
          name: cleanup-report-${{ github.run_id }}
          path: cleanup-report-${{ github.run_id }}.md
          retention-days: 30

      - name: Comment on PR (if applicable)
        if: github.event.client_payload.run_id != ''
        uses: actions/github-script@v7
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            if (prs.length > 0) {
              await github.rest.issues.createComment({
                issue_number: prs[0].number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `ðŸš¨ **Emergency Cleanup Completed** ðŸš¨

                **Environment:** ${{ github.event.client_payload.environment || 'dev' }}
                **Failed Run:** ${{ github.event.client_payload.run_id }}

                All AWS resources have been cleaned up. The repository is ready for a new deployment attempt.

                **Actions performed:**
                - âœ… Terraform destroy (graceful + force)
                - âœ… Comprehensive AWS cleanup
                - âœ… Final verification cleanup

                You can now safely retry the deployment.`
              });
            }