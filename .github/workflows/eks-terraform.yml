name: EKS Terraform Deployment

on:
  # Disabled auto-trigger to prevent accidental infrastructure changes
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'terraform/**'
  #     - '.github/workflows/eks-terraform.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'terraform/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
        default: 'plan'
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'
      migrate_db:
        description: 'Trigger database migration after deployment'
        required: false
        type: boolean
        default: true

env:
  AWS_REGION: us-east-1
  TF_VERSION: '1.9.0'
  TF_VAR_bastion_public_key: ${{ secrets.BASTION_PUBLIC_KEY }}

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    concurrency:
      group: terraform-plan-${{ inputs.environment || 'dev' }}
      cancel-in-progress: false
    defaults:
      run:
        working-directory: terraform/environments/${{ inputs.environment || 'dev' }}

    outputs:
      tfplanExitCode: ${{ steps.tf-plan.outputs.exitcode }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full git history to ensure latest commits

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Validate Required Secrets
        run: |
          echo "Validating secrets required for Terraform deployment..."

          if [[ -z "${{ secrets.BASTION_PUBLIC_KEY }}" ]]; then
            echo "âŒ BASTION_PUBLIC_KEY secret is not configured"
            echo "Please add BASTION_PUBLIC_KEY to repository secrets"
            exit 1
          else
            echo "âœ… BASTION_PUBLIC_KEY is configured"
          fi

          if [[ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" || -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]]; then
            echo "âŒ AWS credentials are not configured"
            exit 1
          else
            echo "âœ… AWS credentials are configured"
          fi

      - name: Clean Terraform Cache
        run: |
          rm -rf .terraform
          rm -f .terraform.lock.hcl
          rm -f terraform.tfstate*

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: |
          # Retry Terraform init up to 3 times to handle provider download issues
          for i in {1..3}; do
            echo "Terraform init attempt $i..."
            if terraform init -upgrade; then
              echo "Terraform init successful on attempt $i"
              break
            else
              echo "Terraform init failed on attempt $i"
              if [ $i -eq 3 ]; then
                echo "Terraform init failed after 3 attempts"
                exit 1
              fi
              echo "Waiting 10 seconds before retry..."
              sleep 10
            fi
          done

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Plan
        id: tf-plan
        run: |
          export exitcode=0
          terraform plan -detailed-exitcode -no-color -out=tfplan || export exitcode=$?

          echo "exitcode=$exitcode" >> $GITHUB_OUTPUT

          if [ $exitcode -eq 1 ]; then
            echo "Terraform Plan Failed!"
            exit 1
          else
            exit 0
          fi

      - name: Publish Terraform Plan
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN: "terraform\n${{ steps.tf-plan.outputs.stdout }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Format and Style \`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization \`${{ steps.init.outcome }}\`
            #### Terraform Validation \`${{ steps.validate.outcome }}\`
            <details><summary>Validation Output</summary>

            \`\`\`\n
            ${{ steps.validate.outputs.stdout }}
            \`\`\`

            </details>

            #### Terraform Plan \`${{ steps.tf-plan.outcome }}\`

            <details><summary>Show Plan</summary>

            \`\`\`\n
            ${process.env.PLAN}
            \`\`\`

            </details>

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Environment: \`${{ inputs.environment || 'dev' }}\`, Workflow: \`${{ github.workflow }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ inputs.environment || 'dev' }}
          path: terraform/environments/${{ inputs.environment || 'dev' }}/tfplan

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [terraform-plan]
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'apply'
    concurrency:
      group: terraform-apply-${{ inputs.environment || 'dev' }}
      cancel-in-progress: true
    defaults:
      run:
        working-directory: terraform/environments/${{ inputs.environment || 'dev' }}

    # Environment approval removed for auto-deployment
    # environment:
    #   name: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full git history to ensure latest commits

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Clean Terraform Cache
        run: |
          rm -rf .terraform
          rm -f .terraform.lock.hcl
          rm -f terraform.tfstate*

      - name: Terraform Init
        run: terraform init -upgrade

      - name: Import Existing Resources
        run: |
          chmod +x ../../../scripts/import-existing-resources.sh
          ../../../scripts/import-existing-resources.sh
        continue-on-error: true

      - name: Terraform Plan
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

      - name: Terraform Output
        id: tf-output
        run: |
          terraform output -json > terraform_outputs.json
          echo "Terraform outputs saved"

      - name: Upload Terraform Outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-${{ inputs.environment || 'dev' }}
          path: terraform/environments/${{ inputs.environment || 'dev' }}/terraform_outputs.json

      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name $(terraform output -raw cluster_name)
          kubectl get nodes

      - name: Infrastructure Deployment Summary
        run: |
          echo "### Infrastructure Deployment Successful ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment || 'dev' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Infrastructure Created:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… VPC and Networking" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… EKS Cluster" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Node Groups" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ECR Repositories" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… IAM Roles and Policies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… RDS PostgreSQL Instance" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Bastion Host for Migration" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… S3 Migration Bucket" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**RDS Endpoint:** $(terraform output -raw rds_instance_endpoint)" >> $GITHUB_STEP_SUMMARY
          echo "**Bastion IP:** $(terraform output -raw bastion_public_ip)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Run database-migration workflow to migrate local data to RDS" >> $GITHUB_STEP_SUMMARY
          echo "2. Update application configurations to use RDS endpoint" >> $GITHUB_STEP_SUMMARY
          echo "3. Deploy applications with deploy-to-eks workflow" >> $GITHUB_STEP_SUMMARY

  trigger-database-migration:
    name: Trigger Database Migration
    runs-on: ubuntu-latest
    needs: terraform-apply
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'apply' && inputs.migrate_db == true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full git history to ensure latest commits

      - name: Trigger Database Migration
        run: |
          echo "ðŸš€ Triggering database migration workflow..."

          # Use GitHub API to trigger migration workflow
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d "{
              \"event_type\": \"database_migration\",
              \"client_payload\": {
                \"environment\": \"${{ inputs.environment || 'dev' }}\",
                \"triggered_by\": \"${{ github.workflow }}\",
                \"run_id\": \"${{ github.run_id }}\"
              }
            }"

          echo "âœ… Database migration workflow triggered"
          echo "ðŸ“‹ Migration will run automatically after this workflow completes" >> $GITHUB_STEP_SUMMARY

  terraform-destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'destroy'
    defaults:
      run:
        working-directory: terraform/environments/${{ inputs.environment || 'dev' }}

    # Environment approval removed for auto-deployment
    # environment:
    #   name: ${{ github.event.inputs.environment || 'dev' }}-destroy

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full git history to ensure latest commits

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init -upgrade

      - name: Terraform Destroy
        run: terraform destroy -auto-approve
