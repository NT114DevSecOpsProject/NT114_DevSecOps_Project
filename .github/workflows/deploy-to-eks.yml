name: Deploy Applications to EKS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'
      services:
        description: 'Services to deploy (comma-separated or "all")'
        required: true
        default: 'all'

env:
  AWS_REGION: us-east-1
  CLUSTER_NAME: eks-1

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set ECR Account ID
        id: aws-account
        run: |
          # Hard-coded to match ECR repository location
          ACCOUNT_ID="767900165633"
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "ECR Account ID (hard-coded): $ACCOUNT_ID"
          echo ""
          echo "Current AWS Account: $(aws sts get-caller-identity --query Account --output text)"

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.12.0'

      - name: Check EKS Cluster Exists
        run: |
          echo "Checking if EKS cluster '${{ env.CLUSTER_NAME }}' exists..."
          if aws eks describe-cluster --region ${{ env.AWS_REGION }} --name ${{ env.CLUSTER_NAME }} > /dev/null 2>&1; then
            echo "âœ… Cluster found: ${{ env.CLUSTER_NAME }}"
          else
            echo "âŒ ERROR: Cluster '${{ env.CLUSTER_NAME }}' not found!"
            echo ""
            echo "Available clusters:"
            aws eks list-clusters --region ${{ env.AWS_REGION }}
            echo ""
            echo "Please create the EKS cluster first by running:"
            echo "  gh workflow run eks-terraform.yml -f action=apply -f environment=dev"
            exit 1
          fi

      - name: Configure kubectl
        run: |
          echo "Configuring kubectl for cluster: ${{ env.CLUSTER_NAME }}"
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.CLUSTER_NAME }}

          echo "Cluster info:"
          kubectl cluster-info

          echo ""
          echo "Node status:"
          kubectl get nodes

      - name: Create namespace
        run: |
          kubectl create namespace ${{ github.event.inputs.environment }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Create ECR Secret (Cross-Account)
        run: |
          # Note: This assumes GitHub Actions AWS credentials have permission to access ECR in account 767900165633
          # If using different accounts, ensure proper IAM permissions are configured

          echo "Creating ECR secret for account 767900165633..."
          kubectl create secret docker-registry ecr-secret \
            --docker-server=767900165633.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com \
            --docker-username=AWS \
            --docker-password=$(aws ecr get-login-password --region ${{ env.AWS_REGION }}) \
            --namespace=${{ github.event.inputs.environment }} \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "ECR secret created. Note: Ensure AWS credentials have access to account 767900165633 ECR."

      - name: Cleanup Stuck Helm Releases
        run: |
          echo "Checking for stuck Helm releases..."

          SERVICES=("api-gateway" "user-management-service" "exercises-service" "scores-service" "frontend")

          for service in "${SERVICES[@]}"; do
            if helm status "$service" -n ${{ github.event.inputs.environment }} 2>/dev/null | grep -q "STATUS: pending"; then
              echo "âš ï¸ Found stuck release: $service. Cleaning up..."
              helm uninstall "$service" -n ${{ github.event.inputs.environment }} --wait || true
            elif helm status "$service" -n ${{ github.event.inputs.environment }} 2>/dev/null | grep -q "STATUS: failed"; then
              echo "âš ï¸ Found failed release: $service. Cleaning up..."
              helm uninstall "$service" -n ${{ github.event.inputs.environment }} --wait || true
            fi
          done

          echo "âœ… Cleanup complete"

      - name: Deploy PostgreSQL
        id: deploy-postgres
        run: |
          echo "Deploying PostgreSQL database..."
          kubectl apply -f kubernetes/local/postgres-deployment.yaml -n ${{ github.event.inputs.environment }}

          echo "Waiting for PostgreSQL to be ready..."
          if kubectl wait --for=condition=ready pod -l app=postgres -n ${{ github.event.inputs.environment }} --timeout=300s; then
            echo "âœ… PostgreSQL is ready!"
            kubectl get pods -l app=postgres -n ${{ github.event.inputs.environment }}
          else
            echo "âŒ PostgreSQL failed to become ready within timeout"
            echo "Pod status:"
            kubectl get pods -l app=postgres -n ${{ github.event.inputs.environment }}
            echo ""
            echo "Pod description:"
            kubectl describe pods -l app=postgres -n ${{ github.event.inputs.environment }}
            echo ""
            echo "Pod logs:"
            kubectl logs -l app=postgres -n ${{ github.event.inputs.environment }} --tail=50 || true
            exit 1
          fi

      - name: Deploy API Gateway
        if: contains(github.event.inputs.services, 'all') || contains(github.event.inputs.services, 'api-gateway')
        run: |
          echo "Deploying API Gateway..."

          if helm upgrade --install api-gateway ./helm/api-gateway \
            --namespace ${{ github.event.inputs.environment }} \
            --set image.repository=${{ steps.aws-account.outputs.account_id }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/nt114-devsecops/api-gateway \
            --set image.tag=latest \
            --wait --timeout 5m; then
            echo "âœ… API Gateway deployed successfully"
          else
            echo "âŒ API Gateway deployment failed!"
            echo ""
            echo "=== POD STATUS ==="
            kubectl get pods -l app.kubernetes.io/name=api-gateway -n ${{ github.event.inputs.environment }} || true
            echo ""
            echo "=== POD DESCRIBE ==="
            kubectl describe pod -l app.kubernetes.io/name=api-gateway -n ${{ github.event.inputs.environment }} || true
            echo ""
            echo "=== POD LOGS ==="
            kubectl logs -l app.kubernetes.io/name=api-gateway -n ${{ github.event.inputs.environment }} --tail=100 || true
            echo ""
            echo "=== EVENTS ==="
            kubectl get events -n ${{ github.event.inputs.environment }} --sort-by='.lastTimestamp' --field-selector involvedObject.kind=Pod | grep api-gateway | tail -20 || true
            exit 1
          fi

      - name: Deploy User Management Service
        if: contains(github.event.inputs.services, 'all') || contains(github.event.inputs.services, 'user-management')
        run: |
          echo "Deploying User Management Service..."

          helm upgrade --install user-management-service ./helm/user-management-service \
            --namespace ${{ github.event.inputs.environment }} \
            --set image.repository=${{ steps.aws-account.outputs.account_id }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/nt114-devsecops/user-management-service \
            --set image.tag=latest \
            --wait --timeout 10m

          echo "âœ… User Management Service deployed successfully"

      - name: Deploy Exercises Service
        if: contains(github.event.inputs.services, 'all') || contains(github.event.inputs.services, 'exercises')
        run: |
          echo "Deploying Exercises Service..."

          helm upgrade --install exercises-service ./helm/exercises-service \
            --namespace ${{ github.event.inputs.environment }} \
            --set image.repository=${{ steps.aws-account.outputs.account_id }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/nt114-devsecops/exercises-service \
            --set image.tag=latest \
            --wait --timeout 10m

          echo "âœ… Exercises Service deployed successfully"

      - name: Deploy Scores Service
        if: contains(github.event.inputs.services, 'all') || contains(github.event.inputs.services, 'scores')
        run: |
          echo "Deploying Scores Service..."

          helm upgrade --install scores-service ./helm/scores-service \
            --namespace ${{ github.event.inputs.environment }} \
            --set image.repository=${{ steps.aws-account.outputs.account_id }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/nt114-devsecops/scores-service \
            --set image.tag=latest \
            --wait --timeout 10m

          echo "âœ… Scores Service deployed successfully"

      - name: Deploy Frontend
        if: contains(github.event.inputs.services, 'all') || contains(github.event.inputs.services, 'frontend')
        run: |
          echo "Deploying Frontend..."

          helm upgrade --install frontend ./helm/frontend \
            --namespace ${{ github.event.inputs.environment }} \
            --set image.repository=${{ steps.aws-account.outputs.account_id }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/nt114-devsecops/frontend \
            --set image.tag=latest \
            --wait --timeout 10m

          echo "âœ… Frontend deployed successfully"

      - name: Get Service URLs
        run: |
          echo "### ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** ${{ env.CLUSTER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "#### ðŸ“‹ Deployed Services" >> $GITHUB_STEP_SUMMARY
          kubectl get deployments -n ${{ github.event.inputs.environment }} >> $GITHUB_STEP_SUMMARY || echo "No deployments found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "#### ðŸŒ Service Endpoints" >> $GITHUB_STEP_SUMMARY
          kubectl get services -n ${{ github.event.inputs.environment }} >> $GITHUB_STEP_SUMMARY || echo "No services found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "#### ðŸ”— Ingress URLs" >> $GITHUB_STEP_SUMMARY
          kubectl get ingress -n ${{ github.event.inputs.environment }} >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No ingress found (ALB Controller may not be installed)" >> $GITHUB_STEP_SUMMARY

      - name: Check Pod Status
        run: |
          echo "### Pod Status" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ github.event.inputs.environment }} -o wide >> $GITHUB_STEP_SUMMARY || true

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pod Events (if any issues)" >> $GITHUB_STEP_SUMMARY
          kubectl get events -n ${{ github.event.inputs.environment }} --sort-by='.lastTimestamp' --field-selector type!=Normal | tail -20 >> $GITHUB_STEP_SUMMARY || echo "No concerning events" >> $GITHUB_STEP_SUMMARY

  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy]
    if: success()
    continue-on-error: true

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.CLUSTER_NAME }}

      - name: Verify All Pods Running
        run: |
          echo "Waiting for all pods to be ready..."
          kubectl wait --for=condition=ready pod --all -n ${{ github.event.inputs.environment }} --timeout=600s

          echo "### âœ… All Pods are Running!" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ github.event.inputs.environment }} >> $GITHUB_STEP_SUMMARY

      - name: Run Health Checks
        run: |
          echo "### ðŸ¥ Health Check Results" >> $GITHUB_STEP_SUMMARY

          # Test API Gateway health
          API_GATEWAY_IP=$(kubectl get service api-gateway -n ${{ github.event.inputs.environment }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          if [ ! -z "$API_GATEWAY_IP" ]; then
            echo "**API Gateway:** $API_GATEWAY_IP" >> $GITHUB_STEP_SUMMARY
            curl -f http://$API_GATEWAY_IP/health || echo "âŒ Health check failed" >> $GITHUB_STEP_SUMMARY
          fi
