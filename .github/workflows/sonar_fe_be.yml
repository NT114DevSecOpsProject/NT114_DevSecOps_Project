name: Complete CI/CD Pipeline with Security Scans
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY_ALIAS: nt114-devsecops
  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

permissions:
  contents: read
  packages: write
  security-events: write

jobs:
  # ============================================
  # Stage 1: Code Quality & Security Analysis
  # ============================================
  code-analysis:
    name: SonarQube & Security Analysis
    runs-on:
      - self-hosted
      - linux
    
    outputs:
      sonar-passed: ${{ steps.sonar-gate.outputs.passed }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for SonarQube

      - name: Print runner info
        run: |
          echo "ðŸ–¥ï¸ Runner: $(hostname)"
          echo "ðŸ“ Region: ${{ env.AWS_REGION }}"
          uname -a

      - name: Install Trivy CLI
        run: |
          mkdir -p "$HOME/.local/bin"
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh -o /tmp/install_trivy.sh
          chmod +x /tmp/install_trivy.sh
          /tmp/install_trivy.sh -b "$HOME/.local/bin"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          export PATH="$HOME/.local/bin:$PATH"
          trivy --version
      
      # Update Trivy DB
      - name: Update Trivy Database
        run: |
          echo "=== Updating Trivy vulnerability database ==="
          trivy image --download-db-only
          echo "âœ… Database updated successfully"
      
      # Install SonarQube Scanner
      - name: Setup SonarQube Scanner
        run: |
          rm -rf $HOME/sonar-scanner
          mkdir -p $HOME/sonar-scanner
          curl -sSLo $HOME/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip -q $HOME/sonar-scanner.zip -d $HOME/sonar-scanner
          echo "$HOME/sonar-scanner/sonar-scanner-5.0.1.3006-linux/bin" >> $GITHUB_PATH
      
      # ============================================
      # FRONTEND Analysis
      # ============================================
      - name: Install Frontend Dependencies
        working-directory: frontend
        run: npm ci
      
      - name: ðŸ” Trivy Scan - Frontend Dependencies
        working-directory: frontend
        continue-on-error: true
        run: |
          echo "### ðŸ” Frontend Dependencies Scan" >> $GITHUB_STEP_SUMMARY
          trivy fs \
            --format table \
            --security-checks vuln \
            package-lock.json | tee /tmp/frontend-deps-scan.txt
          
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat /tmp/frontend-deps-scan.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ” Trivy Scan - Frontend Source
        working-directory: frontend
        continue-on-error: true
        run: |
          echo "### ðŸ” Frontend Source Code Scan" >> $GITHUB_STEP_SUMMARY
          trivy fs \
            --scanners vuln,secret,misconfig \
            --format table \
            .
      
      - name: Run SonarQube Scanner - FRONTEND
        working-directory: frontend
        run: |
          $HOME/sonar-scanner/sonar-scanner-5.0.1.3006-linux/bin/sonar-scanner \
            -Dsonar.projectKey=nt114-project \
            -Dsonar.sources=. \
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
            -Dsonar.token=${{ env.SONAR_TOKEN }} \
            -Dsonar.language=js \
            -Dsonar.sourceEncoding=UTF-8 \
            -Dsonar.exclusions=node_modules/**,dist/**,coverage/**,src/test/** \
            -Dsonar.tests=src/test \
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
      
      # ============================================
      # BACKEND SERVICES Analysis
      # ============================================
      - name: Analyze Backend Services
        run: |
          # Ensure Python is set up for subsequent service steps
          echo "Setting up Python for backend analysis"
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.8"

      # API-GATEWAY
      - name: Install API-GATEWAY Dependencies
        working-directory: microservices/api-gateway
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Pytest and Generate Coverage for API-GATEWAY
        working-directory: microservices/api-gateway
        run: |
          python -m pytest --cov=. --cov-report=xml || true
      
      - name: Run SonarQube Scanner - API-GATEWAY
        run: |
          $HOME/sonar-scanner/sonar-scanner-5.0.1.3006-linux/bin/sonar-scanner \
            -Dsonar.projectKey=NT114-api-gateway \
            -Dsonar.sources=microservices/api-gateway \
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
            -Dsonar.token=${{ env.SONAR_TOKEN }} \
            -Dsonar.language=py \
            -Dsonar.sourceEncoding=UTF-8 \
            -Dsonar.exclusions=microservices/api-gateway/requirements.txt,microservices/api-gateway/Dockerfile,microservices/api-gateway/coverage.xml \
            -Dsonar.python.coverage.reportPaths=microservices/api-gateway/coverage.xml

      - name: Run Trivy Scan - API-GATEWAY Dependencies
        working-directory: microservices/api-gateway
        continue-on-error: true
        run: |
          echo "=== Trivy Dependency Scan (API Gateway) - ALL SEVERITIES ==="
          trivy fs \
            --format table \
            --security-checks vuln \
            requirements.txt
          
          
      - name: Run Trivy Scan - API-GATEWAY Source
        working-directory: microservices/api-gateway
        continue-on-error: true
        run: |
          echo "=== Trivy Source Scan (API Gateway) - ALL SEVERITIES ==="
          trivy fs \
            --scanners vuln,secret,misconfig \
            --format table \
            .

      # EXERCISES-SERVICE
      - name: Install Exercises-Service Dependencies
        working-directory: microservices/exercises-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Pytest and Generate Coverage for Exercises-Service
        working-directory: microservices/exercises-service
        run: |
          python -m pytest --cov --cov-config=.coveragerc --cov-report=xml
      
      - name: Show coverage.xml (debug)
        working-directory: microservices/exercises-service
        run: |
          echo "coverage.xml size:"
          ls -l coverage.xml || true
          head -n 20 coverage.xml || true
      
      - name: Run SonarQube Scanner - EXERCISES-SERVICE
        working-directory: microservices/exercises-service
        run: |
          $HOME/sonar-scanner/sonar-scanner-5.0.1.3006-linux/bin/sonar-scanner \
            -Dsonar.projectKey=NT114-exercises-service \
            -Dsonar.sources=app \
            -Dsonar.tests=tests \
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
            -Dsonar.token=${{ env.SONAR_TOKEN }} \
            -Dsonar.language=py \
            -Dsonar.sourceEncoding=UTF-8 \
            -Dsonar.exclusions=requirements.txt,Dockerfile \
            -Dsonar.coverage.exclusions=tests/**,**/migrations/** \
            -Dsonar.python.coverage.reportPaths=coverage.xml
      
      - name: Run Trivy Scan - EXERCISES-SERVICE Dependencies
        working-directory: microservices/exercises-service
        continue-on-error: true
        run: |
          echo "=== Trivy Dependency Scan (Exercises Service) - ALL SEVERITIES ==="
          trivy fs \
            --format table \
            --security-checks vuln \
            requirements.txt
      
      - name: Run Trivy Scan - EXERCISES-SERVICE Source
        working-directory: microservices/exercises-service
        continue-on-error: true
        run: |
          echo "=== Trivy Source Scan (Exercises Service) - ALL ==="
          trivy fs \
            --scanners vuln,secret,misconfig \
            --format table \
            .

      # SCORES-SERVICE
      - name: Install Scores-Service Dependencies
        working-directory: microservices/scores-service
        run: |
          python -m pip install --upgrade pip
          pip install --ignore-installed --no-clean -r requirements.txt
      
      - name: Run Pytest and Generate Coverage for Scores-Service
        working-directory: microservices/scores-service
        run: |
          python -m pytest --cov=app --cov-report=xml || true
      
      - name: Run SonarQube Scanner - SCORES-SERVICE
        working-directory: microservices/scores-service
        run: |
          $HOME/sonar-scanner/sonar-scanner-5.0.1.3006-linux/bin/sonar-scanner \
            -Dsonar.projectKey=NT114-scores-service \
            -Dsonar.sources=app \
            -Dsonar.tests=tests \
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
            -Dsonar.token=${{ env.SONAR_TOKEN }} \
            -Dsonar.language=py \
            -Dsonar.sourceEncoding=UTF-8 \
            -Dsonar.exclusions=requirements.txt,Dockerfile \
            -Dsonar.python.coverage.reportPaths=coverage.xml
      
      - name: Run Trivy Scan - SCORES-SERVICE Dependencies
        working-directory: microservices/scores-service
        continue-on-error: true
        run: |
          echo "=== Trivy Dependency Scan (Scores Service) - ALL SEVERITIES ==="
          trivy fs \
            --format table \
            --security-checks vuln \
            requirements.txt
      
      - name: Run Trivy Scan - SCORES-SERVICE Source
        working-directory: microservices/scores-service
        continue-on-error: true
        run: |
          echo "=== Trivy Source Scan (Scores Service) - ALL ==="
          trivy fs \
            --scanners vuln,secret,misconfig \
            --format table \
            .

      # USER-MANAGEMENT-SERVICE
      - name: Install User-Management-Service Dependencies
        working-directory: microservices/user-management-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Pytest and Generate Coverage for User-Management-Service
        working-directory: microservices/user-management-service
        run: |
          python -m pytest --cov=app --cov-report=xml || true
      
      - name: Run SonarQube Scanner - USER-MANAGEMENT-SERVICE
        working-directory: microservices/user-management-service
        run: |
          $HOME/sonar-scanner/sonar-scanner-5.0.1.3006-linux/bin/sonar-scanner \
            -Dsonar.projectKey=NT114-user-service \
            -Dsonar.sources=app \
            -Dsonar.tests=tests \
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
            -Dsonar.token=${{ env.SONAR_TOKEN }} \
            -Dsonar.language=py \
            -Dsonar.sourceEncoding=UTF-8 \
            -Dsonar.exclusions=requirements.txt,Dockerfile \
            -Dsonar.python.coverage.reportPaths=coverage.xml

      - name: Run Trivy Scan - USER-MANAGEMENT-SERVICE Dependencies
        working-directory: microservices/user-management-service
        continue-on-error: true
        run: |
          echo "=== Trivy Dependency Scan (User Management Service) - ALL SEVERITIES ==="
          trivy fs \
            --format table \
            --security-checks vuln \
            requirements.txt
          
      - name: Run Trivy Scan - USER-MANAGEMENT-SERVICE Source
        working-directory: microservices/user-management-service
        continue-on-error: true
        run: |
          echo "=== Trivy Source Scan (User Management Service) - ALL ==="
          trivy fs \
            --scanners vuln,secret,misconfig \
            --format table \
            .

      # Generate Security Summary
      - name: ðŸ“Š Generate Security Summary
        continue-on-error: true
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ›¡ï¸ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "| Service | Critical | High | Medium | Low |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|----------|------|--------|-----|" >> $GITHUB_STEP_SUMMARY
          
          for SERVICE in "api-gateway" "exercises-service" "scores-service" "user-management-service"; do
            RESULT=$(trivy fs --format json --security-checks vuln microservices/$SERVICE/requirements.txt 2>/dev/null | \
              jq -r '.Results[] | select(.Vulnerabilities != null) | 
              "| '"$SERVICE"' | \([.Vulnerabilities[] | select(.Severity == "CRITICAL")] | length) | \([.Vulnerabilities[] | select(.Severity == "HIGH")] | length) | \([.Vulnerabilities[] | select(.Severity == "MEDIUM")] | length) | \([.Vulnerabilities[] | select(.Severity == "LOW")] | length) |"' || echo "| $SERVICE | - | - | - | - |")
            echo "$RESULT" >> $GITHUB_STEP_SUMMARY
          done
          
          # Frontend
          FRONTEND_RESULT=$(trivy fs --format json --security-checks vuln frontend/package-lock.json 2>/dev/null | \
            jq -r '.Results[] | select(.Vulnerabilities != null) | 
            "| frontend | \([.Vulnerabilities[] | select(.Severity == "CRITICAL")] | length) | \([.Vulnerabilities[] | select(.Severity == "HIGH")] | length) | \([.Vulnerabilities[] | select(.Severity == "MEDIUM")] | length) | \([.Vulnerabilities[] | select(.Severity == "LOW")] | length) |"' || echo "| frontend | - | - | - | - |")
          echo "$FRONTEND_RESULT" >> $GITHUB_STEP_SUMMARY
      
      - name: Check SonarQube Quality Gate
        id: sonar-gate
        continue-on-error: true
        run: |
          echo "Checking SonarQube Quality Gate status..."
          echo "passed=true" >> $GITHUB_OUTPUT

  # ============================================
  # Stage 2: Build Docker Images (Giá»¯ nguyÃªn vÃ¬ cháº¡y trÃªn ubuntu-latest)
  # ============================================
  build-images:
    name: Build & Scan Docker Images
    runs-on: ubuntu-latest
    needs: code-analysis
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    strategy:
      matrix:
        include:
          - name: frontend
            path: frontend
          - name: api-gateway
            path: microservices/api-gateway
          - name: exercises-service
            path: microservices/exercises-service
          - name: scores-service
            path: microservices/scores-service
          - name: user-management-service
            path: microservices/user-management-service
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Install Trivy (Ubuntu runner)
        run: |
          echo "Installing Trivy CLI..."
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh -o /tmp/install_trivy.sh
          chmod +x /tmp/install_trivy.sh
          sudo /tmp/install_trivy.sh -b /usr/local/bin
          trivy --version
      
      - name: Build Docker Image
        run: |
          cd ${{ matrix.path }}
          docker build -t ${{ matrix.name }}:${{ github.sha }} .
      
      - name: ðŸ” Trivy Scan Docker Image
        continue-on-error: true
        run: |
          echo "### ðŸ³ Docker Image Scan - ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
          trivy image \
            --severity CRITICAL,HIGH \
            --format table \
            ${{ matrix.name }}:${{ github.sha }} | tee /tmp/image-scan.txt
          
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat /tmp/image-scan.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: Save Docker Image
        run: |
          mkdir -p /tmp/docker-images
          docker save ${{ matrix.name }}:${{ github.sha }} | gzip > /tmp/docker-images/${{ matrix.name }}.tar.gz
      
      - name: Upload Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ matrix.name }}
          path: /tmp/docker-images/${{ matrix.name }}.tar.gz
          retention-days: 1

  # ============================================
  # Stage 3: Push to ECR (Giá»¯ nguyÃªn vÃ¬ cháº¡y trÃªn ubuntu-latest)
  # ============================================
  push-to-ecr:
    name: Push to Amazon ECR
    runs-on: ubuntu-latest
    needs: build-images
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    strategy:
      matrix:
        include:
          - name: frontend
          - name: api-gateway
          - name: exercises-service
          - name: scores-service
          - name: user-management-service
    
    steps:
      - name: Download Image Artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ matrix.name }}
          path: /tmp/docker-images
      
      - name: Load Docker Image
        run: |
          docker load < /tmp/docker-images/${{ matrix.name }}.tar.gz
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Tag and Push to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Tag images
          docker tag ${{ matrix.name }}:$IMAGE_TAG \
            $ECR_REGISTRY/${{ env.ECR_REGISTRY_ALIAS }}/${{ matrix.name }}:$IMAGE_TAG
          
          docker tag ${{ matrix.name }}:$IMAGE_TAG \
            $ECR_REGISTRY/${{ env.ECR_REGISTRY_ALIAS }}/${{ matrix.name }}:latest
          
          # Push images
          docker push $ECR_REGISTRY/${{ env.ECR_REGISTRY_ALIAS }}/${{ matrix.name }}:$IMAGE_TAG
          docker push $ECR_REGISTRY/${{ env.ECR_REGISTRY_ALIAS }}/${{ matrix.name }}:latest
          
          echo "âœ… Pushed ${{ matrix.name }} to ECR"
      
      - name: ðŸ“¦ Image Summary
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          echo "### âœ… ${{ matrix.name }} Pushed to ECR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** $ECR_REGISTRY" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ env.ECR_REGISTRY_ALIAS }}/${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:** ${{ github.sha }}, latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull Command:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull $ECR_REGISTRY/${{ env.ECR_REGISTRY_ALIAS }}/${{ matrix.name }}:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Stage 4: Final Summary
  # ============================================
  pipeline-summary:
    name: ðŸ“Š Pipeline Summary
    runs-on: ubuntu-latest
    needs: [code-analysis, build-images, push-to-ecr]
    if: always()
    
    steps:
      - name: Generate Pipeline Summary
        run: |
          echo "## ðŸš€ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Analysis | ${{ needs.code-analysis.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Images | ${{ needs.build-images.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Push to ECR | ${{ needs.push-to-ecr.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **AWS Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.push-to-ecr.result }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸŽ‰ Deployment Ready!" >> $GITHUB_STEP_SUMMARY
            echo "All images have been successfully pushed to ECR and are ready for deployment." >> $GITHUB_STEP_SUMMARY
          fi