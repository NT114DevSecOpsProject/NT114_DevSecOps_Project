name: Complete CI/CD Pipeline with Security Scans
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY_ALIAS: nt114-devsecops

permissions:
  contents: read
  packages: write
  security-events: write

jobs:
  # =============================================
  # Stage 1: Code Quality & Security Analysis
  # =============================================
  code-analysis:
    name: SonarCloud & Security Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better SonarCloud analysis

      - name: Install Trivy CLI
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          trivy --version
      
      - name: Update Trivy Database
        run: |
          echo "=== Updating Trivy vulnerability database ==="
          trivy image --download-db-only
          echo "âœ… Database updated successfully"
      
      # ============================================
      # FRONTEND Analysis
      # ============================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install Frontend Dependencies
        working-directory: frontend
        run: npm ci
      
      - name: Run Frontend Tests with Coverage
        working-directory: frontend
        run: npm test -- --coverage --watchAll=false
        continue-on-error: true
      
      - name: ðŸ” Trivy Scan - Frontend Dependencies
        working-directory: frontend
        continue-on-error: true
        run: |
          echo "### ðŸ” Frontend Dependencies Scan" >> $GITHUB_STEP_SUMMARY
          trivy fs --format table --security-checks vuln package-lock.json
      
      - name: SonarCloud Scan - Frontend
        uses: SonarSource/sonarcloud-github-action@v3.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: frontend
          args: >
            -Dsonar.organization=nt114devsecopsproject
            -Dsonar.projectKey=nt114devsecopsproject_frontend
            -Dsonar.sources=src
            -Dsonar.tests=src
            -Dsonar.test.inclusions=**/*.test.js,**/*.test.jsx,**/*.test.ts,**/*.test.tsx
            -Dsonar.exclusions=**/node_modules/**,**/build/**,**/dist/**,**/coverage/**
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            

      # ============================================
      # BACKEND SERVICES Analysis
      # ============================================
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
      
      # API-GATEWAY
      - name: Install API-GATEWAY Dependencies
        working-directory: microservices/api-gateway
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run Tests - API-GATEWAY
        working-directory: microservices/api-gateway
        run: python -m pytest --cov=. --cov-report=xml
        continue-on-error: true
      
      - name: SonarCloud Scan - API Gateway
        uses: SonarSource/sonarcloud-github-action@v3.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: microservices/api-gateway
          args: >
            -Dsonar.organization=nt114devsecopsproject
            -Dsonar.projectKey=nt114devsecopsproject_api-gateway
            -Dsonar.python.coverage.reportPaths=coverage.xml
            -Dsonar.python.version=3.9

      - name: Trivy Scan - API-GATEWAY
        working-directory: microservices/api-gateway
        continue-on-error: true
        run: trivy fs --format table --security-checks vuln requirements.txt

      # EXERCISES-SERVICE
      - name: Install Exercises-Service Dependencies
        working-directory: microservices/exercises-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run Tests - Exercises-Service
        working-directory: microservices/exercises-service
        run: python -m pytest --cov=app --cov-report=xml
        continue-on-error: true
      
      - name: SonarCloud Scan - Exercises Service
        uses: SonarSource/sonarcloud-github-action@v3.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: microservices/exercises-service
          args: >
            -Dsonar.organization=nt114devsecopsproject
            -Dsonar.projectKey=nt114devsecopsproject_exercises-service
            -Dsonar.python.coverage.reportPaths=coverage.xml
            -Dsonar.python.version=3.9

      - name: Trivy Scan - Exercises Service
        working-directory: microservices/exercises-service
        continue-on-error: true
        run: trivy fs --format table --security-checks vuln requirements.txt

      # SCORES-SERVICE
      - name: Install Scores-Service Dependencies
        working-directory: microservices/scores-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run Tests - Scores-Service
        working-directory: microservices/scores-service
        run: python -m pytest --cov=app --cov-report=xml
        continue-on-error: true
      
      - name: SonarCloud Scan - Scores Service
        uses: SonarSource/sonarcloud-github-action@v3.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: microservices/scores-service
          args: >
            -Dsonar.organization=nt114devsecopsproject
            -Dsonar.projectKey=nt114devsecopsproject_scores-service
            -Dsonar.python.coverage.reportPaths=coverage.xml
            -Dsonar.python.version=3.9

      - name: Trivy Scan - Scores Service
        working-directory: microservices/scores-service
        continue-on-error: true
        run: trivy fs --format table --security-checks vuln requirements.txt

      # USER-MANAGEMENT-SERVICE
      - name: Install User-Management-Service Dependencies
        working-directory: microservices/user-management-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run Tests - User-Management-Service
        working-directory: microservices/user-management-service
        run: python -m pytest --cov=app --cov-report=xml
        continue-on-error: true
      
      - name: SonarCloud Scan - User Management Service
        uses: SonarSource/sonarcloud-github-action@v3.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: microservices/user-management-service
          args: >
            -Dsonar.organization=nt114devsecopsproject
            -Dsonar.projectKey=nt114devsecopsproject_user-management-service
            -Dsonar.python.coverage.reportPaths=coverage.xml
            -Dsonar.python.version=3.9

      - name: Trivy Scan - User Management Service
        working-directory: microservices/user-management-service
        continue-on-error: true
        run: trivy fs --format table --security-checks vuln requirements.txt

      # Generate Security Summary
      - name: ðŸ“Š Generate Security Summary
        continue-on-error: true
        run: |
          echo "## ðŸ›¡ï¸ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” SonarCloud Analysis" >> $GITHUB_STEP_SUMMARY
          echo "View detailed reports at: https://sonarcloud.io/organizations/nt114devsecopsproject/projects" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ› Trivy Vulnerability Scans" >> $GITHUB_STEP_SUMMARY
          echo "All services scanned for dependencies and source code vulnerabilities." >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Stage 2: Build Docker Images
  # ============================================
  build-images:
    name: Build & Scan Docker Images
    runs-on: ubuntu-latest
    needs: code-analysis
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    strategy:
      matrix:
        include:
          - name: frontend
            path: frontend
          - name: api-gateway
            path: microservices/api-gateway
          - name: exercises-service
            path: microservices/exercises-service
          - name: scores-service
            path: microservices/scores-service
          - name: user-management-service
            path: microservices/user-management-service
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin
          trivy --version
      
      - name: Build Docker Image
        run: |
          cd ${{ matrix.path }}
          docker build -t ${{ matrix.name }}:${{ github.sha }} .
      
      - name: ðŸ” Trivy Scan Docker Image
        continue-on-error: true
        run: |
          trivy image --severity CRITICAL,HIGH --format table ${{ matrix.name }}:${{ github.sha }}
      
      - name: Save Docker Image
        run: |
          mkdir -p /tmp/docker-images
          docker save ${{ matrix.name }}:${{ github.sha }} | gzip > /tmp/docker-images/${{ matrix.name }}.tar.gz
      
      - name: Upload Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ matrix.name }}
          path: /tmp/docker-images/${{ matrix.name }}.tar.gz
          retention-days: 1

  # ============================================
  # Stage 3: Push to ECR
  # ============================================
  push-to-ecr:
    name: Push to Amazon ECR
    runs-on: ubuntu-latest
    needs: build-images
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    strategy:
      matrix:
        include:
          - name: frontend
          - name: api-gateway
          - name: exercises-service
          - name: scores-service
          - name: user-management-service
    
    steps:
      - name: Download Image Artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-${{ matrix.name }}
          path: /tmp/docker-images
      
      - name: Load Docker Image
        run: docker load < /tmp/docker-images/${{ matrix.name }}.tar.gz
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Tag and Push to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker tag ${{ matrix.name }}:$IMAGE_TAG \
            $ECR_REGISTRY/${{ env.ECR_REGISTRY_ALIAS }}/${{ matrix.name }}:$IMAGE_TAG
          docker tag ${{ matrix.name }}:$IMAGE_TAG \
            $ECR_REGISTRY/${{ env.ECR_REGISTRY_ALIAS }}/${{ matrix.name }}:latest
          docker push $ECR_REGISTRY/${{ env.ECR_REGISTRY_ALIAS }}/${{ matrix.name }}:$IMAGE_TAG
          docker push $ECR_REGISTRY/${{ env.ECR_REGISTRY_ALIAS }}/${{ matrix.name }}:latest

  # ============================================
  # Stage 4: Pipeline Summary
  # ============================================
  pipeline-summary:
    name: ðŸ“Š Pipeline Summary
    runs-on: ubuntu-latest
    needs: [code-analysis, build-images, push-to-ecr]
    if: always()
    
    steps:
      - name: Generate Pipeline Summary
        run: |
          echo "## ðŸš€ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Analysis | ${{ needs.code-analysis.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Images | ${{ needs.build-images.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Push to ECR | ${{ needs.push-to-ecr.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY