name: SonarQube Analysis (frontend and microservices)
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  sonar:
    name: SonarQube Scan
    runs-on:
      - self-hosted
      - linux
    env:
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Print runner info (debug)
        run: |
          echo "RUNNER: $(hostname)"; uname -a
          echo "Checking access to Sonar at $SONAR_HOST_URL"
          curl -v --max-time 10 $SONAR_HOST_URL/api/server/version || true
      
      # Update Trivy DB to ensure latest vulnerability data
      - name: Update Trivy Database
        run: |
          echo "=== Updating Trivy vulnerability database ==="
          trivy image --download-db-only
          echo "Database updated successfully"
      
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: temurin
      
      - name: Remove old sonar-scanner folder if exists
        run: rm -rf $HOME/sonar-scanner
      
      - name: Download Sonar Scanner
        run: |
          mkdir -p $HOME/sonar-scanner
          curl -sSLo $HOME/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip -q $HOME/sonar-scanner.zip -d $HOME/sonar-scanner
      
      - name: Setup Node and Install Frontend Dependencies
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json
      
      - name: Run Trivy Scan - FRONTEND Dependencies
        working-directory: frontend
        continue-on-error: true
        run: |
          echo "=== Trivy Dependency Scan (Frontend) - ALL SEVERITIES ==="
          trivy fs \
            --format table \
            --security-checks vuln \
            package-lock.json
      
      - name: Run Trivy Scan - FRONTEND Source
        working-directory: frontend
        continue-on-error: true
        run: |
          echo "=== Trivy Source Scan (Frontend) - ALL SEVERITIES ==="
          trivy fs \
            --format table \
            --scanners vuln,secret,misconfig \
            .
      
      - name: Run SonarQube Scanner - FRONTEND
        run: |
          $HOME/sonar-scanner/sonar-scanner-5.0.1.3006-linux/bin/sonar-scanner \
            -Dsonar.projectKey=nt114-project \
            -Dsonar.sources=frontend/src \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.token=${SONAR_TOKEN} \
            -Dsonar.language=js \
            -Dsonar.sourceEncoding=UTF-8 \
            -Dsonar.exclusions=frontend/node_modules/**,frontend/dist/**,frontend/coverage/**,frontend/src/test/** \
            -Dsonar.tests=frontend/src/test \
            -Dsonar.javascript.lcov.reportPaths=frontend/coverage/lcov.info
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.8"
      
      # API-GATEWAY
      - name: Install API-GATEWAY Dependencies
        working-directory: microservices/api-gateway
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Pytest and Generate Coverage for API-GATEWAY
        working-directory: microservices/api-gateway
        run: |
          python -m pytest --cov=. --cov-report=xml || true
      
      - name: Run SonarQube Scanner - API-GATEWAY
        run: |
          $HOME/sonar-scanner/sonar-scanner-5.0.1.3006-linux/bin/sonar-scanner \
            -Dsonar.projectKey=NT114-api-gateway \
            -Dsonar.sources=microservices/api-gateway \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.token=${SONAR_TOKEN} \
            -Dsonar.language=py \
            -Dsonar.sourceEncoding=UTF-8 \
            -Dsonar.exclusions=microservices/api-gateway/requirements.txt,microservices/api-gateway/Dockerfile,microservices/api-gateway/coverage.xml \
            -Dsonar.python.coverage.reportPaths=microservices/api-gateway/coverage.xml
      
      - name: Run Trivy Scan - API-GATEWAY Dependencies
        working-directory: microservices/api-gateway
        continue-on-error: true
        run: |
          echo "=== Trivy Dependency Scan (API Gateway) - ALL SEVERITIES ==="
          trivy fs \
            --format table \
            --security-checks vuln \
            requirements.txt
          
          
      - name: Run Trivy Scan - API-GATEWAY Source
        working-directory: microservices/api-gateway
        continue-on-error: true
        run: |
          echo "=== Trivy Source Scan (API Gateway) - ALL SEVERITIES ==="
          trivy fs \
            --scanners vuln,secret,misconfig \
            --format table \
            .
      
      - name: Run Trivy Scan - API-GATEWAY Dockerfile
        working-directory: microservices/api-gateway
        continue-on-error: true
        run: |
          echo "=== Trivy Dockerfile Scan (API Gateway) ==="
          trivy config Dockerfile || true

      # EXERCISES-SERVICE
      - name: Install Exercises-Service Dependencies
        working-directory: microservices/exercises-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Pytest and Generate Coverage for Exercises-Service
        working-directory: microservices/exercises-service
        run: |
          python -m pytest --cov --cov-config=.coveragerc --cov-report=xml
      
      - name: Show coverage.xml (debug)
        working-directory: microservices/exercises-service
        run: |
          echo "coverage.xml size:"
          ls -l coverage.xml || true
          head -n 20 coverage.xml || true
      
      - name: Run SonarQube Scanner - EXERCISES-SERVICE
        working-directory: microservices/exercises-service
        run: |
          $HOME/sonar-scanner/sonar-scanner-5.0.1.3006-linux/bin/sonar-scanner \
            -Dsonar.projectKey=NT114-exercises-service \
            -Dsonar.sources=app \
            -Dsonar.tests=tests \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.token=${SONAR_TOKEN} \
            -Dsonar.language=py \
            -Dsonar.sourceEncoding=UTF-8 \
            -Dsonar.exclusions=requirements.txt,Dockerfile \
            -Dsonar.coverage.exclusions=tests/**,**/migrations/** \
            -Dsonar.python.coverage.reportPaths=coverage.xml
      
      - name: Run Trivy Scan - EXERCISES-SERVICE Dependencies
        working-directory: microservices/exercises-service
        continue-on-error: true
        run: |
          echo "=== Trivy Dependency Scan (Exercises Service) - ALL SEVERITIES ==="
          trivy fs \
            --format table \
            --security-checks vuln \
            requirements.txt
      
      - name: Run Trivy Scan - EXERCISES-SERVICE Source
        working-directory: microservices/exercises-service
        continue-on-error: true
        run: |
          echo "=== Trivy Source Scan (Exercises Service) - ALL ==="
          trivy fs \
            --scanners vuln,secret,misconfig \
            --format table \
            .
      
      - name: Run Trivy Scan - EXERCISES-SERVICE Dockerfile
        working-directory: microservices/exercises-service
        continue-on-error: true
        run: |
          echo "=== Trivy Dockerfile Scan (Exercises Service) ==="
          trivy config Dockerfile || true

      # SCORES-SERVICE
      - name: Install Scores-Service Dependencies
        working-directory: microservices/scores-service
        run: |
          python -m pip install --upgrade pip
          pip install --ignore-installed --no-clean -r requirements.txt
      
      - name: Run Pytest and Generate Coverage for Scores-Service
        working-directory: microservices/scores-service
        run: |
          python -m pytest --cov=app --cov-report=xml || true
      
      - name: Run SonarQube Scanner - SCORES-SERVICE
        working-directory: microservices/scores-service
        run: |
          $HOME/sonar-scanner/sonar-scanner-5.0.1.3006-linux/bin/sonar-scanner \
            -Dsonar.projectKey=NT114-scores-service \
            -Dsonar.sources=app \
            -Dsonar.tests=tests \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.token=${SONAR_TOKEN} \
            -Dsonar.language=py \
            -Dsonar.sourceEncoding=UTF-8 \
            -Dsonar.exclusions=requirements.txt,Dockerfile \
            -Dsonar.python.coverage.reportPaths=coverage.xml
      
      - name: Run Trivy Scan - SCORES-SERVICE Dependencies
        working-directory: microservices/scores-service
        continue-on-error: true
        run: |
          echo "=== Trivy Dependency Scan (Scores Service) - ALL SEVERITIES ==="
          trivy fs \
            --format table \
            --security-checks vuln \
            requirements.txt
      
      - name: Run Trivy Scan - SCORES-SERVICE Source
        working-directory: microservices/scores-service
        continue-on-error: true
        run: |
          echo "=== Trivy Source Scan (Scores Service) - ALL ==="
          trivy fs \
            --scanners vuln,secret,misconfig \
            --format table \
            .

      # USER-MANAGEMENT-SERVICE
      - name: Install User-Management-Service Dependencies
        working-directory: microservices/user-management-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Pytest and Generate Coverage for User-Management-Service
        working-directory: microservices/user-management-service
        run: |
          python -m pytest --cov=app --cov-report=xml || true
      
      - name: Run SonarQube Scanner - USER-MANAGEMENT-SERVICE
        working-directory: microservices/user-management-service
        run: |
          $HOME/sonar-scanner/sonar-scanner-5.0.1.3006-linux/bin/sonar-scanner \
            -Dsonar.projectKey=NT114-user-service \
            -Dsonar.sources=app \
            -Dsonar.tests=tests \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.token=${SONAR_TOKEN} \
            -Dsonar.language=py \
            -Dsonar.sourceEncoding=UTF-8 \
            -Dsonar.exclusions=requirements.txt,Dockerfile \
            -Dsonar.python.coverage.reportPaths=coverage.xml
      
      - name: Run Trivy Scan - USER-MANAGEMENT-SERVICE Dependencies
        working-directory: microservices/user-management-service
        continue-on-error: true
        run: |
          echo "=== Trivy Dependency Scan (User Management Service) - ALL SEVERITIES ==="
          trivy fs \
            --format table \
            --security-checks vuln \
            requirements.txt
          
      - name: Run Trivy Scan - USER-MANAGEMENT-SERVICE Source
        working-directory: microservices/user-management-service
        continue-on-error: true
        run: |
          echo "=== Trivy Source Scan (User Management Service) - ALL ==="
          trivy fs \
            --scanners vuln,secret,misconfig \
            --format table \
            .
      
      # Generate consolidated security report
      - name: Generate Consolidated Trivy Report
        continue-on-error: true
        run: |
          echo "=========================================="
          echo "CONSOLIDATED SECURITY SCAN SUMMARY"
          echo "=========================================="
          echo ""
          
          echo "=== API Gateway ==="
          trivy fs --format json --security-checks vuln microservices/api-gateway/requirements.txt 2>/dev/null | jq -r '.Results[] | select(.Vulnerabilities != null) | "Total: \(.Vulnerabilities | length), Critical: \([.Vulnerabilities[] | select(.Severity == "CRITICAL")] | length), High: \([.Vulnerabilities[] | select(.Severity == "HIGH")] | length)"' || echo "No vulnerabilities or scan failed"
          
          echo ""
          echo "=== Exercises Service ==="
          trivy fs --format json --security-checks vuln microservices/exercises-service/requirements.txt 2>/dev/null | jq -r '.Results[] | select(.Vulnerabilities != null) | "Total: \(.Vulnerabilities | length), Critical: \([.Vulnerabilities[] | select(.Severity == "CRITICAL")] | length), High: \([.Vulnerabilities[] | select(.Severity == "HIGH")] | length)"' || echo "No vulnerabilities or scan failed"
          
          echo ""
          echo "=== Scores Service ==="
          trivy fs --format json --security-checks vuln microservices/scores-service/requirements.txt 2>/dev/null | jq -r '.Results[] | select(.Vulnerabilities != null) | "Total: \(.Vulnerabilities | length), Critical: \([.Vulnerabilities[] | select(.Severity == "CRITICAL")] | length), High: \([.Vulnerabilities[] | select(.Severity == "HIGH")] | length)"' || echo "No vulnerabilities or scan failed"
          
          echo ""
          echo "=== User Management Service ==="
          trivy fs --format json --security-checks vuln microservices/user-management-service/requirements.txt 2>/dev/null | jq -r '.Results[] | select(.Vulnerabilities != null) | "Total: \(.Vulnerabilities | length), Critical: \([.Vulnerabilities[] | select(.Severity == "CRITICAL")] | length), High: \([.Vulnerabilities[] | select(.Severity == "HIGH")] | length)"' || echo "No vulnerabilities or scan failed"
          
          echo ""
          echo "=== Frontend ==="
          trivy fs --format json --security-checks vuln frontend/package-lock.json 2>/dev/null | jq -r '.Results[] | select(.Vulnerabilities != null) | "Total: \(.Vulnerabilities | length), Critical: \([.Vulnerabilities[] | select(.Severity == "CRITICAL")] | length), High: \([.Vulnerabilities[] | select(.Severity == "HIGH")] | length)"' || echo "No vulnerabilities or scan failed"
          
          echo ""
          echo "==============================="