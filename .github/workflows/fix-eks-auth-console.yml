name: Fix EKS Auth via AWS API

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  CLUSTER_NAME: eks-1

permissions:
  contents: read

jobs:
  fix-auth:
    name: Add IAM User to EKS (via AWS API)
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get cluster endpoint and CA
        id: cluster
        run: |
          ENDPOINT=$(aws eks describe-cluster --name ${{ env.CLUSTER_NAME }} --query 'cluster.endpoint' --output text)
          CA_DATA=$(aws eks describe-cluster --name ${{ env.CLUSTER_NAME }} --query 'cluster.certificateAuthority.data' --output text)
          echo "endpoint=$ENDPOINT" >> $GITHUB_OUTPUT
          echo "ca_data=$CA_DATA" >> $GITHUB_OUTPUT

      - name: Create aws-auth ConfigMap patch
        run: |
          cat > aws-auth-patch.yaml <<'EOF'
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: aws-auth
            namespace: kube-system
          data:
            mapUsers: |
              - userarn: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID || '039612870452' }}:user/test_user
                username: test_user
                groups:
                  - system:masters
          EOF

          echo "ConfigMap to apply:"
          cat aws-auth-patch.yaml

      - name: Apply using AWS EKS API
        run: |
          # Get auth token
          TOKEN=$(aws eks get-token --cluster-name ${{ env.CLUSTER_NAME }} --query 'status.token' --output text)

          # Apply ConfigMap via Kubernetes API
          curl -X PATCH \
            "${{ steps.cluster.outputs.endpoint }}/api/v1/namespaces/kube-system/configmaps/aws-auth" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/strategic-merge-patch+json" \
            --cacert <(echo "${{ steps.cluster.outputs.ca_data }}" | base64 -d) \
            -d @aws-auth-patch.yaml \
            --insecure

      - name: Verify
        run: |
          echo "✓ aws-auth ConfigMap updated"
          echo ""
          echo "Test access locally:"
          echo "  aws eks update-kubeconfig --region us-east-1 --name eks-1"
          echo "  kubectl get nodes"

      - name: Create summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<'EOF'
          ## ✅ EKS Authentication Fixed

          ### What was done
          - Updated aws-auth ConfigMap via AWS EKS API
          - Added test_user with system:masters permissions

          ### Test Access
          ```bash
          aws eks update-kubeconfig --region us-east-1 --name eks-1
          kubectl get nodes
          ```

          ### Next Steps
          Run deployment workflow:
          - Actions → Deploy Complete Stack (App + ArgoCD)
          - Click "Run workflow"
          EOF
