name: Database Migration

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to migrate'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'
      migration_action:
        description: 'Migration action'
        required: true
        type: choice
        options:
          - dry_run
          - migrate
          - validate
        default: 'dry_run'
      backup_local_db:
        description: 'Backup local database before migration'
        required: false
        type: boolean
        default: true

env:
  AWS_REGION: us-east-1
  TF_VERSION: '1.9.0'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  pre-migration-checks:
    name: Pre-Migration Checks
    runs-on: ubuntu-latest
    outputs:
      can_proceed: ${{ steps.check.outputs.can_proceed }}
      local_db_status: ${{ steps.check.outputs.local_db_status }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Check Local Database Status
        id: check
        run: |
          echo "ðŸ” Checking pre-migration requirements..."

          # Check if local PostgreSQL is running
          if docker ps --format "table {{.Names}}" | grep -q postgres; then
            echo "âœ… Local PostgreSQL is running"
            local_db_status="running"
          else
            echo "âš ï¸ Local PostgreSQL not found - this may be a dry run"
            local_db_status="not_running"
          fi

          # Check if RDS exists and is accessible
          if terraform -chdir=terraform/environments/${{ inputs.environment }} init -backend=false && \
             terraform -chdir=terraform/environments/${{ inputs.environment }} show -json | jq -r '.values.outputs.rds_instance_endpoint.value' | grep -q "rds.amazonaws.com"; then
            echo "âœ… RDS instance exists"
            rds_status="exists"
          else
            echo "âŒ RDS instance not found - run eks-terraform.yml first"
            rds_status="missing"
            can_proceed="false"
          fi

          if [[ "$rds_status" == "exists" ]]; then
            can_proceed="true"
          fi

          echo "can_proceed=$can_proceed" >> $GITHUB_OUTPUT
          echo "local_db_status=$local_db_status" >> $GITHUB_OUTPUT

      - name: Validation Results
        run: |
          echo "### Pre-Migration Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Migration Action:** ${{ inputs.migration_action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Local DB Status:** ${{ steps.check.outputs.local_db_status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Can Proceed:** ${{ steps.check.outputs.can_proceed }}" >> $GITHUB_STEP_SUMMARY

  local-database-backup:
    name: Backup Local Database
    runs-on: ubuntu-latest
    needs: pre-migration-checks
    if: needs.pre-migration-checks.outputs.can_proceed == 'true' && inputs.backup_local_db == 'true' && needs.pre-migration-checks.outputs.local_db_status == 'running'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Backup Local Databases
        run: |
          echo "ðŸ”„ Starting local database backup..."

          timestamp=$(date +%Y%m%d_%H%M%S)
          backup_dir="backups/${{ inputs.environment }}_${timestamp}"
          mkdir -p $backup_dir

          # Backup auth_db
          echo "Backing up auth_db..."
          docker exec postgres pg_dump -U postgres -h localhost auth_db > $backup_dir/auth_db_backup.sql || true

          # Backup exercises_db
          echo "Backing up exercises_db..."
          docker exec postgres pg_dump -U postgres -h localhost exercises_db > $backup_dir/exercises_db_backup.sql || true

          # Backup scores_db
          echo "Backing up scores_db..."
          docker exec postgres pg_dump -U postgres -h localhost scores_db > $backup_dir/scores_db_backup.sql || true

          # Create compressed archive
          tar -czf "backups/${{ inputs.environment }}_database_backup_${timestamp}.tar.gz" -C backups "${{ inputs.environment }}_${timestamp}"

          echo "âœ… Database backup completed: backups/${{ inputs.environment }}_database_backup_${timestamp}.tar.gz"

          # Upload as artifact
          mkdir -p backup-artifacts
          cp "backups/${{ inputs.environment }}_database_backup_${timestamp}.tar.gz" backup-artifacts/

      - name: Upload Backup Artifact
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ inputs.environment }}
          path: backup-artifacts/
          retention-days: 30

  prepare-migration:
    name: Prepare Migration
    runs-on: ubuntu-latest
    needs: pre-migration-checks
    if: needs.pre-migration-checks.outputs.can_proceed == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Get RDS Connection Details
        id: rds
        run: |
          cd terraform/environments/${{ inputs.environment }}
          terraform init -backend=false

          # Get RDS connection details
          rds_endpoint=$(terraform output -raw rds_instance_endpoint 2>/dev/null || echo "")
          rds_port=$(terraform output -raw rds_instance_port 2>/dev/null || echo "5432")
          rds_username=$(terraform output -raw rds_instance_username 2>/dev/null || echo "postgres")
          rds_password=$(terraform output -raw rds_instance_password 2>/dev/null || echo "")

          echo "rds_endpoint=$rds_endpoint" >> $GITHUB_OUTPUT
          echo "rds_port=$rds_port" >> $GITHUB_OUTPUT
          echo "rds_username=$rds_username" >> $GITHUB_OUTPUT
          echo "rds_password=$rds_password" >> $GITHUB_OUTPUT

      - name: Generate Migration Scripts
        run: |
          echo "ðŸ“ Generating migration scripts..."

          mkdir -p migration-scripts

          cat > migration-scripts/export_local_data.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "ðŸ”„ Exporting data from local PostgreSQL..."

          # Export databases
          databases=("auth_db" "exercises_db" "scores_db")

          for db in "${databases[@]}"; do
            echo "Exporting $db..."
            docker exec postgres pg_dump -U postgres -h localhost \
              --no-owner --no-privileges --data-only \
              $db > migration-scripts/${db}_data.sql || {
              echo "Warning: Failed to export $db (may be empty)"
            }
          done

          echo "âœ… Data export completed"
          EOF

          chmod +x migration-scripts/export_local_data.sh

          cat > migration-scripts/validate_migration.sh << 'EOF'
          #!/bin/bash
          set -e

          DB_HOST="${1}"
          DB_PORT="${2}"
          DB_USERNAME="${3}"
          DB_PASSWORD="${4}"

          echo "ðŸ” Validating migration results..."

          # Check database connectivity
          PGPASSWORD="$DB_PASSWORD" pg_isready -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USERNAME"

          databases=("auth_db" "exercises_db" "scores_db")
          validation_passed=true

          for db in "${databases[@]}"; do
            echo "Validating $db..."

            # Check if database exists
            if PGPASSWORD="$DB_PASSWORD" psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USERNAME" -lqt | cut -d \| -f 1 | grep -qw "$db"; then
              echo "âœ… Database $db exists"

              # Count rows in main tables
              case $db in
                "auth_db")
                  if PGPASSWORD="$DB_PASSWORD" psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USERNAME" -d "$db" -tAc "SELECT COUNT(*) FROM users" > /dev/null 2>&1; then
                    user_count=$(PGPASSWORD="$DB_PASSWORD" psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USERNAME" -d "$db" -tAc "SELECT COUNT(*) FROM users")
                    echo "  Users: $user_count rows"
                  else
                    echo "  âš ï¸ Users table not found or empty"
                  fi
                  ;;
                "exercises_db")
                  if PGPASSWORD="$DB_PASSWORD" psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USERNAME" -d "$db" -tAc "SELECT COUNT(*) FROM exercises" > /dev/null 2>&1; then
                    exercise_count=$(PGPASSWORD="$DB_PASSWORD" psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USERNAME" -d "$db" -tAc "SELECT COUNT(*) FROM exercises")
                    echo "  Exercises: $exercise_count rows"
                  else
                    echo "  âš ï¸ Exercises table not found or empty"
                  fi
                  ;;
                "scores_db")
                  if PGPASSWORD="$DB_PASSWORD" psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USERNAME" -d "$db" -tAc "SELECT COUNT(*) FROM scores" > /dev/null 2>&1; then
                    score_count=$(PGPASSWORD="$DB_PASSWORD" psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USERNAME" -d "$db" -tAc "SELECT COUNT(*) FROM scores")
                    echo "  Scores: $score_count rows"
                  else
                    echo "  âš ï¸ Scores table not found or empty"
                  fi
                  ;;
              esac
            else
              echo "âŒ Database $db not found"
              validation_passed=false
            fi
          done

          if [ "$validation_passed" = true ]; then
            echo "âœ… Migration validation completed successfully"
            exit 0
          else
            echo "âŒ Migration validation failed"
            exit 1
          fi
          EOF

          chmod +x migration-scripts/validate_migration.sh

      - name: Upload Migration Scripts
        uses: actions/upload-artifact@v4
        with:
          name: migration-scripts-${{ inputs.environment }}
          path: migration-scripts/
          retention-days: 7

  execute-migration:
    name: Execute Database Migration
    runs-on: ubuntu-latest
    needs: [pre-migration-checks, prepare-migration, local-database-backup]
    if: needs.pre-migration-checks.outputs.can_proceed == 'true' && inputs.migration_action == 'migrate'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Download Migration Scripts
        uses: actions/download-artifact@v4
        with:
          name: migration-scripts-${{ inputs.environment }}
          path: migration-scripts/

      - name: Get Terraform Outputs
        id: tf_outputs
        run: |
          cd terraform/environments/${{ inputs.environment }}
          terraform init -backend=false

          rds_endpoint=$(terraform output -raw rds_instance_endpoint)
          rds_port=$(terraform output -raw rds_instance_port)
          rds_username=$(terraform output -raw rds_instance_username)
          rds_password=$(terraform output -raw rds_instance_password)
          bastion_ip=$(terraform output -raw bastion_public_ip)
          bastion_key_name=$(terraform output -raw bastion_key_name)

          echo "rds_endpoint=$rds_endpoint" >> $GITHUB_OUTPUT
          echo "rds_port=$rds_port" >> $GITHUB_OUTPUT
          echo "rds_username=$rds_username" >> $GITHUB_OUTPUT
          echo "rds_password=$rds_password" >> $GITHUB_OUTPUT
          echo "bastion_ip=$bastion_ip" >> $GITHUB_OUTPUT
          echo "bastion_key_name=$bastion_key_name" >> $GITHUB_OUTPUT

      - name: Validate Migration Secrets
        run: |
          echo "Validating secrets required for database migration..."

          required_secrets=(
            "AWS_ACCESS_KEY_ID"
            "AWS_SECRET_ACCESS_KEY"
            "BASTION_SSH_PRIVATE_KEY"
          )

          for secret in "${required_secrets[@]}"; do
            if [[ -z "${{ secrets[secret] }}" ]]; then
              echo "âŒ $secret secret is not configured"
              echo "Please add $secret to repository secrets"
              exit 1
            else
              echo "âœ… $secret is configured"
            fi
          done

      - name: Setup SSH Key
        run: |
          echo "${{ secrets.BASTION_SSH_PRIVATE_KEY }}" > bastion_key.pem
          chmod 400 bastion_key.pem

      - name: Export Local Data
        run: |
          if [ "${{ needs.pre-migration-checks.outputs.local_db_status }}" = "running" ]; then
            echo "ðŸ”„ Exporting data from local database..."
            ./migration-scripts/export_local_data.sh
          else
            echo "âš ï¸ Local database not running, skipping data export"
          fi

      - name: Upload Data to Bastion
        run: |
          echo "ðŸ“¤ Uploading migration data to bastion host..."

          # Create migration directory on bastion
          ssh -i bastion_key.pem -o StrictHostKeyChecking=no \
            ec2-user@${{ steps.tf_outputs.outputs.bastion_ip }} \
            "mkdir -p /home/ec2-user/migration"

          # Upload migration files
          scp -i bastion_key.pem -o StrictHostKeyChecking=no \
            migration-scripts/*_data.sql \
            ec2-user@${{ steps.tf_outputs.outputs.bastion_ip }}:/home/ec2-user/migration/ 2>/dev/null || true

      - name: Execute Migration on Bastion
        run: |
          echo "ðŸš€ Executing database migration on bastion host..."

          ssh -i bastion_key.pem -o StrictHostKeyChecking=no \
            ec2-user@${{ steps.tf_outputs.outputs.bastion_ip }} \
            "cd /opt/migration && ./migrate_database.sh"

      - name: Validate Migration Results
        run: |
          echo "ðŸ” Validating migration results..."

          # Run validation script
          if [ -f migration-scripts/validate_migration.sh ]; then
            ./migration-scripts/validate_migration.sh \
              "${{ steps.tf_outputs.outputs.rds_endpoint }}" \
              "${{ steps.tf_outputs.outputs.rds_port }}" \
              "${{ steps.tf_outputs.outputs.rds_username }}" \
              "${{ steps.tf_outputs.outputs.rds_password }}"
          else
            echo "âš ï¸ Validation script not found, manual validation required"
          fi

  validate-migration:
    name: Validate Migration Results
    runs-on: ubuntu-latest
    needs: [pre-migration-checks, prepare-migration]
    if: needs.pre-migration-checks.outputs.can_proceed == 'true' && inputs.migration_action == 'validate'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Get RDS Connection Details
        id: rds
        run: |
          cd terraform/environments/${{ inputs.environment }}
          terraform init -backend=false

          rds_endpoint=$(terraform output -raw rds_instance_endpoint)
          rds_port=$(terraform output -raw rds_instance_port)
          rds_username=$(terraform output -raw rds_instance_username)
          rds_password=$(terraform output -raw rds_instance_password)

          echo "rds_endpoint=$rds_endpoint" >> $GITHUB_OUTPUT
          echo "rds_port=$rds_port" >> $GITHUB_OUTPUT
          echo "rds_username=$rds_username" >> $GITHUB_OUTPUT
          echo "rds_password=$rds_password" >> $GITHUB_OUTPUT

      - name: Download Migration Scripts
        uses: actions/download-artifact@v4
        with:
          name: migration-scripts-${{ inputs.environment }}
          path: migration-scripts/

      - name: Validate Database Structure
        run: |
          echo "ðŸ” Validating RDS database structure..."

          # Install PostgreSQL client
          sudo apt-get update
          sudo apt-get install -y postgresql-client

          # Run validation
          if [ -f migration-scripts/validate_migration.sh ]; then
            ./migration-scripts/validate_migration.sh \
              "${{ steps.rds.outputs.rds_endpoint }}" \
              "${{ steps.rds.outputs.rds_port }}" \
              "${{ steps.rds.outputs.rds_username }}" \
              "${{ steps.rds.outputs.rds_password }}"
          else
            echo "âš ï¸ Validation script not found"

            # Manual validation
            databases=("auth_db" "exercises_db" "scores_db")
            for db in "${databases[@]}"; do
              echo "Checking $db..."
              PGPASSWORD="${{ steps.rds.outputs.rds_password }}" psql \
                -h "${{ steps.rds.outputs.rds_endpoint }}" \
                -p "${{ steps.rds.outputs.rds_port }}" \
                -U "${{ steps.rds.outputs.rds_username }}" \
                -d "$db" -c "\dt" || echo "Database $db not accessible"
            done
          fi

  migration-summary:
    name: Migration Summary
    runs-on: ubuntu-latest
    needs: [pre-migration-checks, local-database-backup, execute-migration, validate-migration]
    if: always() && needs.pre-migration-checks.result == 'success'

    steps:
      - name: Generate Migration Summary
        run: |
          echo "### Database Migration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Migration Action:** ${{ inputs.migration_action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Can Proceed:** ${{ needs.pre-migration-checks.outputs.can_proceed }}" >> $GITHUB_STEP_SUMMARY
          echo "**Local DB Status:** ${{ needs.pre-migration-checks.outputs.local_db_status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- Pre-Migration Checks: ${{ needs.pre-migration-checks.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Local Database Backup: ${{ needs.local-database-backup.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Execute Migration: ${{ needs.execute-migration.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Validate Migration: ${{ needs.validate-migration.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.execute-migration.result }}" == "success" || "${{ needs.validate-migration.result }}" == "success" ]]; then
            echo "### âœ… Migration Completed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Next steps:" >> $GITHUB_STEP_SUMMARY
            echo "1. Update application configurations to use RDS endpoint" >> $GITHUB_STEP_SUMMARY
            echo "2. Test application connectivity to RDS" >> $GITHUB_STEP_SUMMARY
            echo "3. Decommission local PostgreSQL (if applicable)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Migration Issues Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the job logs and resolve any issues before proceeding." >> $GITHUB_STEP_SUMMARY
          fi