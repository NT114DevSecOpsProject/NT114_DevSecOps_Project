name: Fix EKS Auth (Direct Method)

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: eks-1

permissions:
  contents: read

jobs:
  fix-auth:
    name: Add IAM User to EKS aws-auth
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install eksctl
        run: |
          curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
          sudo mv /tmp/eksctl /usr/local/bin
          eksctl version

      - name: Get IAM user ARN
        id: iam
        run: |
          USER_ARN=$(aws iam get-user --user-name test_user --query 'User.Arn' --output text)
          echo "user_arn=$USER_ARN" >> $GITHUB_OUTPUT
          echo "IAM User ARN: $USER_ARN"

      - name: Create identity mapping
        run: |
          echo "Adding test_user to EKS cluster..."

          eksctl create iamidentitymapping \
            --cluster ${{ env.EKS_CLUSTER_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --arn ${{ steps.iam.outputs.user_arn }} \
            --username test_user \
            --group system:masters \
            --no-duplicate-arns || echo "User might already exist, continuing..."

          echo "✓ IAM user added"

      - name: List all identity mappings
        run: |
          echo "Current IAM identity mappings:"
          eksctl get iamidentitymapping \
            --cluster ${{ env.EKS_CLUSTER_NAME }} \
            --region ${{ env.AWS_REGION }}

      - name: Create summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ✅ EKS Authentication Fixed!

          ### What was done

          - ✅ Added IAM user \`test_user\` to EKS cluster
          - ✅ Granted \`system:masters\` permissions
          - ✅ User ARN: \`${{ steps.iam.outputs.user_arn }}\`

          ### Test Access (Run these commands)

          \`\`\`bash
          # Update kubeconfig
          aws eks update-kubeconfig --region us-east-1 --name eks-1

          # Test access
          kubectl get nodes
          kubectl get pods --all-namespaces
          \`\`\`

          ### Deploy Application Now

          1. Go to **Actions** tab
          2. Click **"Deploy Complete Stack (App + ArgoCD)"**
          3. Click **"Run workflow"**
          4. Wait 10-15 minutes
          5. Get ArgoCD credentials from workflow summary

          ---

          **Note:** Changes take effect immediately. You can now run the deployment workflow!
          EOF
